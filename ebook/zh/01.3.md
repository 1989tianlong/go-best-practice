# 3 vagrant使用入门

前面我们已经学会了安装配置vagrant，而且也已经按照默认的方式开启了，那么这一小节给大家介绍vagrant的高级应用。

## vagrant常用命令
前面讲了vagrant的几个命令：

* `vagrant box add` 添加box的操作
* `vagrant init` 初始化box的操作
* `vagrant up` 开启虚拟机的操作
* `vagrant ssh` 登陆虚拟机的操作

vagrant还包括如下一些操作：

* `vagrant box list` 

	显示当前已经添加的box列表

		$ vagrant box list
		base (virtualbox)
		
* `vagrant box remove` 
	
	删除相应的box

		$ vagrant box remove base virtualbox
		Removing box 'base' with provider 'virtualbox'...

* `vagrant destroy` 

	停止当前正在运行的虚拟机并销毁所有创建的资源
	
		$ vagrant destroy
		Are you sure you want to destroy the 'default' VM? [y/N] y
		[default] Destroying VM and associated drives...

* `vagrant halt`  

	关机
	
		$ vagrant halt
		[default] Attempting graceful shutdown of VM...
	
* `vagrant package` 

	打包命令，可以把当前的运行的包进行打包
	
		$ vagrant package
		[default] Attempting graceful shutdown of VM...
		[default] Clearing any previously set forwarded ports...
		[default] Creating temporary directory for export...
		[default] Exporting VM...
		[default] Compressing package to: /Users/astaxie/vagrant/package.box
	
* `vagrant plugin` 

	用于安装卸载插件
	
* `vagrant provision` 

	通常情况下Box只做最基本的设置，而不是设置好所有的环境，因此vagrant通常使用chef或者Puppet来做进一步的环境搭建。那么chef或者Puppet称为provisioning，而该命令就是指定开启相应的provisioning。

	例如： `vagrant provision --provision-with chef`
	
* `vagrant reload`  

	重新启动，主要用于重新载入配置文件
	
		$ vagrant reload
		[default] Attempting graceful shutdown of VM...
		[default] Setting the name of the VM...
		[default] Clearing any previously set forwarded ports...
		[default] Creating shared folders metadata...
		[default] Clearing any previously set network interfaces...
		[default] Preparing network interfaces based on configuration...
		[default] Forwarding ports...
		[default] -- 22 => 2222 (adapter 1)
		[default] Booting VM...
		[default] Waiting for VM to boot. This can take a few minutes.
		[default] VM booted and ready for use!
		[default] Setting hostname...
		[default] Mounting shared folders...
		[default] -- /vagrant
		
* `vagrant resume` 

	恢复前面被挂起的状态
	
		$vagrant resume
		[default] Resuming suspended VM...
		[default] Booting VM...
		[default] Waiting for VM to boot. This can take a few minutes.
		[default] VM booted and ready for use!
		
* `vagrant ssh-config` 

	输出用于ssh链接的一些信息
	
		$vagrant ssh-config
		Host default
		  HostName 127.0.0.1
		  User vagrant
		  Port 2222
		  UserKnownHostsFile /dev/null
		  StrictHostKeyChecking no
		  PasswordAuthentication no
		  IdentityFile "/Users/astaxie/.vagrant.d/insecure_private_key"
		  IdentitiesOnly yes
		  LogLevel FATAL
	
* `vagrant status` 

	获取当前虚拟机的状态
	
		$vagrant status
		Current machine states:
		
		default                   running (virtualbox)
		
		The VM is running. To stop this VM, you can run `vagrant halt` to
		shut it down forcefully, or you can run `vagrant suspend` to simply
		suspend the virtual machine. In either case, to restart it again,
		simply run `vagrant up`.

* `vagrant suspend` 

	挂起当前的状态

		$ vagrant suspend
		[default] Saving VM state and suspending execution...

## 模拟打造多机器的分布式系统
前面这些单机单台主要是用来自己做开发机，这个部分的内容主要是方便大家进行分布式系统设计时单机打造集群用的，这种多机器模式特别是以下几种人：

1. 快速建立产品网络的多机器环境，例如web服务器、db服务器
1. 建立一个分布式系统，学习他们是如何交互的
1. 测试API和其他组件的通信
1. 容灾模拟，网络断网、机器死机、链接超时等情况

vagrant支持单机模拟多台机器，而且支持一个配置文件VagrntFile就可以跑分布式系统。

现在我们来建立多台VM跑起來，並且让他们之间能够相通，假设一台是Application、一台是DB服务器，那么这个结构在Vagrant中非常简单，其实和单台的配置差不多，你只需要通过`config.vm.define`来定义不同的角色就可以了，现在我们打开配置文件设置如下：

	Vagrant.configure("2") do |config|
	  config.vm.define :web do |web|
	    web.vm.provider "virtualbox" do |v|
	          v.customize ["modifyvm", :id, "--name", "web", "--memory", "512"]
	    end
	    web.vm.box = "base"
	    web.vm.hostname = "web"
	    web.vm.network :private_network, ip: "11.11.1.1"
	  end
	
	  config.vm.define :db do |db|
	    db.vm.provider "virtualbox" do |v|
	          v.customize ["modifyvm", :id, "--name", "db", "--memory", "512"]
	    end
	    db.vm.box = "base"
	    db.vm.hostname = "db"
	    db.vm.network :private_network, ip: "11.11.1.2"
	  end
	end

这里的设置和前面我们单机设置配置类似，只是我们使用了:web以及:db分別做了两个VM的设置，并且给每个VM设置了不同的hostname和IP，设置好之后再使用`vagrant up`将虚拟机跑起来：

	$ vagrant up
	Bringing machine 'web' up with 'virtualbox' provider...
	Bringing machine 'db' up with 'virtualbox' provider...
	[web] Setting the name of the VM...
	[web] Clearing any previously set forwarded ports...
	[web] Creating shared folders metadata...
	[web] Clearing any previously set network interfaces...
	[web] Preparing network interfaces based on configuration...
	[web] Forwarding ports...
	[web] -- 22 => 2222 (adapter 1)
	[web] Running any VM customizations...
	[web] Booting VM...
	[web] Waiting for VM to boot. This can take a few minutes.
	[web] VM booted and ready for use!
	[web] Setting hostname...
	[web] Configuring and enabling network interfaces...
	[web] Mounting shared folders...
	[web] -- /vagrant
	[db] Setting the name of the VM...
	[db] Clearing any previously set forwarded ports...
	[db] Fixed port collision for 22 => 2222. Now on port 2200.
	[db] Creating shared folders metadata...
	[db] Clearing any previously set network interfaces...
	[db] Preparing network interfaces based on configuration...
	[db] Forwarding ports...
	[db] -- 22 => 2200 (adapter 1)
	[db] Running any VM customizations...
	[db] Booting VM...
	[db] Waiting for VM to boot. This can take a few minutes.
	[db] VM booted and ready for use!
	[db] Setting hostname...
	[db] Configuring and enabling network interfaces...
	[db] Mounting shared folders...
	[db] -- /vagrant	


## links  
  * [目录](<preface.md>)
  * 上一节: [vagrant安装配置](01.2.md)
  * 下一节: [Go环境安装配置](<01.4.md>)